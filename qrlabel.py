#!/usr/bin/python3

import subprocess as sp
import qrcode
import qrcode.image.svg
import argparse
import sys
from textwrap import dedent, wrap


def make_label(text: str, filename: str = 'output.svg'):
    a = 240
    b = 3
    font_size = a / (len(text) + b)
    lines = wrap(dedent(text), width=111_29)

    svg = """<?xml version="1.0" standalone="no"?>
    <svg width="40mm" height="25mm" version="1.1" xmlns="http://www.w3.org/2000/svg">
    """
    h = 9
    x = 75
    y = 50 - (len(lines) * h / 2)
    for line in lines:
        svg += f'<text x="{x}" y="{y}" font-family="monospace" font-size="{font_size}" dominant-baseline="middle" text-anchor="middle">{line}</text>\n'
        y += h

    svg += "</svg>"
    with open(filename, "w") as f:
        f.write(svg)


def make_cookie(fortune_list: str):
    font_size = 8
    cookie = sp.getoutput("fortune -s " + fortune_list)
    cookie = cookie.replace("--", "\r--").replace(">", "&gt;").replace("<", "&lt;")
    lines = wrap(dedent(cookie), width=29)

    svg = """<?xml version="1.0" standalone="no"?>
    <svg width="40mm" height="25mm" version="1.1" xmlns="http://www.w3.org/2000/svg">
    """
    h = 9
    x = 10
    y = 50 - (len(lines) * h / 2)
    for line in lines:
        if line.lstrip().startswith("--"):
            font_size = 6
            x = 20
            y += 5
        svg += f'<text x="{x}" y="{y}" font-family="monospace" font-size="{font_size}">{line}</text>\n'
        y += h

    svg += "</svg>"
    # print(svg)
    with open("output.svg", "w") as f:
        f.write(svg)


def QRCode_svg(tag: str, filename: str = 'output.svg'):
    base_url = "http://7ek.de/"
    url = base_url + tag
    qr = qrcode.QRCode(
        version=1,
        error_correction=qrcode.constants.ERROR_CORRECT_L,
        box_size=25,
        border=4,
    )
    qr.add_data(url)
    qr.make(fit=True)

    factory = qrcode.image.svg.SvgPathImage
    svg = qr.make_image(fill_color="black", back_color="white", image_factory=factory)
    qrcode_svg_data = svg.to_string().decode()
    # print(qrcode_svg_data)

    start = qrcode_svg_data.find("<path")
    end = qrcode_svg_data.find("/></svg>") + len("/>")
    qrcode_svg_data[start:end]

    svg = """<?xml version="1.0" standalone="no"?>
    <svg width="40mm" height="25mm" version="1.1" xmlns="http://www.w3.org/2000/svg">
    """
    svg += qrcode_svg_data[start:end]
    svg += '<g id="g2" transform="translate(0,16)">'
# logo
    svg += """
        <path
    id="path1"
    style="stroke-width:0;stroke-dasharray:none"
    d="m 112.10593,9.3390571 -5.68789,0.2828658 c -0.15958,0.00796 -0.30068,0.137772 -0.32188,0.2958123 l -0.72542,5.3699488 c -0.0159,0.116474 -0.12933,0.263319 -0.23863,0.307142 l -0.002,7.17e-4 -4.07628,1.991208 -0.001,0.0011 c -0.10162,0.05927 -0.2855,0.05728 -0.38519,-0.0047 l -4.675818,-2.877025 c -0.09525,-0.05907 -0.215677,-0.05723 -0.317213,-0.01367 l -0.009,-0.0011 -0.01205,0.006 c -0.03529,0.01749 -0.06765,0.04087 -0.09441,0.07032 l -3.821472,4.221584 c -0.107532,0.118211 -0.115733,0.309891 -0.01978,0.436796 l 3.412368,4.476216 c 0.07104,0.0935 0.09448,0.278122 0.04856,0.386984 l -1.76e-4,0.0016 -1.399762,4.074306 -1.76e-4,0.0016 c -0.03003,0.113885 -0.161412,0.241446 -0.276572,0.26884 l -5.543481,1.321178 c -0.154407,0.03727 -0.26976,0.189307 -0.261826,0.348862 l 0.283046,5.68842 c 0.008,0.159453 0.137575,0.299475 0.295453,0.320628 l 5.746863,0.775947 c 0.116416,0.01562 0.262866,0.130653 0.306063,0.239708 l 5.4e-4,0.0013 0.07445,0.155189 1.717334,3.585182 3.63e-4,0.0015 c 0.05779,0.102149 0.05406,0.287493 -0.0074,0.388063 l -3.05003,4.957781 c -0.08379,0.135724 -0.05658,0.32562 0.06168,0.432661 l 4.222482,3.82201 c 0.118027,0.106841 0.309469,0.115257 0.436258,0.01835 l 4.629606,-3.528715 c 0.0939,-0.07109 0.27765,-0.09267 0.38537,-0.04496 l 0.002,1.97e-4 3.90059,1.411449 8.8e-4,5.9e-4 c 0.11307,0.03233 0.24197,0.16666 0.26885,0.280707 l 1.34312,5.640407 c 0.037,0.155268 0.18979,0.270581 0.34922,0.262365 l 5.68842,-0.283046 c 0.15921,-0.0082 0.29999,-0.1376 0.32117,-0.295633 l 0.76318,-5.647059 c 0.0166,-0.116789 0.13043,-0.260582 0.24043,-0.301927 l 9.1e-4,-3.93e-4 3.9157,-1.796635 0.002,-4.92e-4 c 0.10352,-0.05669 0.28957,-0.05216 0.39023,0.0097 l 4.79289,2.949857 c 0.13621,0.08328 0.32547,0.05671 0.43247,-0.0615 l 3.82111,-4.223022 c 0.10702,-0.118207 0.11638,-0.309761 0.0191,-0.436436 l -3.32767,-4.366703 c -0.0713,-0.09286 -0.0914,-0.275796 -0.0425,-0.382308 l 0.003,-0.0061 0.5508,-4.856007 c 1.81429,-0.372274 2.71859,-0.739983 4.50732,-1.165988 l 0.0115,-0.0028 0.008,-0.0086 c 0.0737,-0.07416 0.12705,-0.21298 0.17695,-0.406405 0.0499,-0.193426 0.092,-0.440486 0.12678,-0.723079 0.0696,-0.565187 0.10736,-1.272429 0.10285,-1.969089 -0.005,-0.696659 -0.0504,-1.382042 -0.15033,-1.905791 -0.05,-0.26187 -0.11316,-0.483242 -0.19295,-0.647012 -0.0798,-0.163767 -0.17856,-0.275037 -0.30607,-0.296712 l -3.30051,-0.864601 -0.005,-3.92e-4 c -2.82724,0.07249 -4.16201,-0.268697 -6.68843,0.309119 l -9.1e-4,3.93e-4 -3.77922,1.060429 0.1365,4.86572 0.0332,0.0061 c 1.40698,0.23762 4.12318,1.39252 4.16979,1.412349 -0.0322,1.356537 -0.0309,2.526535 -0.59018,3.67833 -0.56361,1.160523 -1.69808,2.311223 -4.02216,3.621506 -0.96184,0.542276 -1.98995,0.88287 -3.04139,1.076257 l 0.19511,5.881012 -2.04246,2.182542 -2.18272,-2.042279 -0.20068,-6.054184 c -1.56334,-0.310194 -3.07052,-0.926921 -4.39927,-1.794479 -1.45843,1.724455 -2.91671,3.44895 -4.37515,5.1734 l -0.10196,0.120483 -3.104147,0.259308 -0.259309,-3.103967 0.101961,-0.120483 c 1.523857,-1.801805 3.047675,-3.603564 4.571525,-5.405375 -2.633005,-3.860496 -2.827287,-9.539085 0.59342,-13.410306 3.72862,-4.219669 8.36743,-4.103624 10.5331,-3.781011 l 0.004,3.93e-4 0.004,-3.93e-4 c 0.1252,-3.93e-4 0.27756,0.01249 0.37602,0.03111 l 0.55817,0.105018 c 0.0492,0.0092 0.0987,-0.0076 0.14944,-0.03308 0.0507,-0.02547 0.10331,-0.06231 0.15249,-0.103578 0.0983,-0.08255 0.18419,-0.178547 0.21345,-0.260388 l 2.05919,-4.769691 4.9e-4,-9.04e-4 c 0.0537,-0.150383 -0.0304,-0.312279 -0.18486,-0.354436 l -2.13094,-0.533183 -4.9e-4,1.77e-4 c -0.11447,-0.0242 -0.24333,-0.148615 -0.27027,-0.262186 l -1.2327,-5.1788869 c -0.0374,-0.1545835 -0.19027,-0.269911 -0.34904,-0.262006 z m 18.76605,19.2418669 c 0.0226,0.08488 0.0451,0.170522 0.0638,0.268839 0.0983,0.51531 0.14494,1.198089 0.14943,1.891405 0.005,0.693311 -0.033,1.397476 -0.10196,1.957939 -0.0345,0.280234 -0.0772,0.525223 -0.1257,0.713188 -0.0238,0.09225 -0.05,0.16997 -0.0761,0.231076 -0.0261,0.06111 -0.0523,0.105594 -0.0763,0.131093 -0.89563,0.213877 -1.56827,0.412898 -2.24531,0.605112 0.67699,-0.192201 1.34958,-0.391432 2.24513,-0.605292 0.024,-0.0255 0.0503,-0.0698 0.0764,-0.130913 0.0261,-0.06111 0.0521,-0.139009 0.0759,-0.231256 0.0485,-0.187961 0.0912,-0.432954 0.1257,-0.713187 0.069,-0.560463 0.10645,-1.26463 0.10196,-1.957941 -0.005,-0.693314 -0.0512,-1.376094 -0.14943,-1.891404 -0.0188,-0.09825 -0.0411,-0.183821 -0.0636,-0.268659 z m -9.76112,6.065513 c 4e-4,1.97e-4 0.0146,0.0058 0.0146,0.0058 -1.9e-4,0.0077 -2.9e-4,0.01464 -3.8e-4,0.0223 l -0.0146,-0.01888 z m 6.30182,0.01727 c -0.36909,0.09361 -0.76763,0.186564 -1.22408,0.279628 l -0.0297,0.0058 -0.55764,4.906899 v 1.95e-4 c -0.0223,0.05312 -0.0332,0.11325 -0.0332,0.174071 -6e-5,-0.06093 0.0107,-0.121082 0.033,-0.17425 v -1.97e-4 l 0.55764,-4.906897 0.0297,-0.0058 c 0.45645,-0.09306 0.85517,-0.185838 1.22425,-0.279447 z m 1.61069,10.101875 c 0.02,0.08379 0.002,0.181213 -0.0537,0.242945 l -3.8204,4.222661 c -0.0386,0.04271 -0.0961,0.06936 -0.15626,0.07787 -0.0602,0.0085 -0.12291,-0.0011 -0.17228,-0.03129 l -2e-4,-1.97e-4 c 0.0494,0.03018 0.11233,0.03999 0.17246,0.03146 0.0601,-0.0085 0.11743,-0.03534 0.15608,-0.07804 l 3.82039,-4.222662 c 0.0558,-0.06169 0.0739,-0.159011 0.0539,-0.242765 z m -9.35488,1.508916 c -0.0403,0.0087 -0.0786,0.02261 -0.11294,0.04136 l -4.8e-4,1.96e-4 3.9e-4,-3.93e-4 c 0.0344,-0.01878 0.0728,-0.03243 0.11311,-0.04118 z m -4.02162,1.8344 c -3e-4,9.8e-5 -7e-5,7.86e-4 -4e-4,8.84e-4 -0.0734,0.02781 -0.14138,0.08063 -0.19366,0.146018 0.0523,-0.06534 0.12016,-0.118404 0.19349,-0.146198 2.9e-4,-9.8e-5 1.9e-4,-5.89e-4 4.8e-4,-6.87e-4 z m -0.25949,0.252834 c -0.017,0.03735 -0.0287,0.07624 -0.0341,0.11509 l 2e-4,6.87e-4 -0.76246,5.647059 c -0.007,0.05703 -0.04,0.111476 -0.0847,0.152493 -0.0447,0.04102 -0.10178,0.0686 -0.15933,0.07157 l -5.6877,0.282866 -1.9e-4,-1.97e-4 5.6877,-0.282865 c 0.0575,-0.0029 0.1148,-0.03037 0.1595,-0.07139 0.0447,-0.04102 0.0769,-0.09564 0.0845,-0.152672 l 0.76246,-5.64706 -1.9e-4,-6.88e-4 c 0.005,-0.03884 0.0173,-0.07756 0.0343,-0.114909 z m -8.66274,0.08938 c 1e-4,2.9e-5 3e-4,-2.9e-5 4e-4,0 0.0375,0.0108 0.0744,0.02801 0.10916,0.04999 -0.0349,-0.02208 -0.0718,-0.0392 -0.10952,-0.04999 z" />
        <path
    id="path2"
    style="color:#000000;fill:#000000;fill-rule:evenodd;stroke-width:0;stroke-dasharray:none"
    d="m 111.20662,37.943897 -1.39599,1.498846 0.30859,9.307948 1.42799,1.336102 1.33628,-1.427993 -0.30857,-9.307588 z" />
        <path
    id="path3"
    style="color:#000000;fill:#000000;fill-rule:evenodd;stroke-width:0;stroke-dasharray:none"
    d="m 106.22949,36.310037 -2.21931,0.208924 c -2.08891,2.469922 -4.177827,4.939967 -6.266738,7.409889 l 0.169755,2.030949 2.030949,-0.169755 c 2.105524,-2.489563 6.316544,-7.468692 6.316544,-7.468692 z" />
        <path
    id="path4"
    style="display:inline;stroke-width:0.0982083"
    d="m 110.72829,26.716134 a 5.1805206,5.1805206 0 0 0 -1.65818,0.245281 5.1805206,5.1805206 0 0 0 -3.35734,6.511841 5.1805206,5.1805206 0 0 0 6.51184,3.357342 5.1805206,5.1805206 0 0 0 3.35734,-6.51184 5.1805206,5.1805206 0 0 0 -4.85366,-3.602624 z m -0.0537,2.635342 c 0.22163,3.93e-4 0.28159,0.0042 0.40011,0.02518 0.82963,0.147011 1.50252,0.64717 1.86532,1.386454 0.47443,0.966703 0.27969,2.133942 -0.48319,2.896809 -0.43163,0.431638 -0.98701,0.685759 -1.60727,0.735307 -0.15261,0.01219 -0.19371,0.01217 -0.36505,-1.97e-4 -0.59512,-0.04288 -1.16721,-0.303981 -1.59649,-0.728652 -0.20231,-0.200141 -0.35634,-0.417028 -0.48877,-0.688013 -0.18151,-0.371454 -0.25427,-0.688761 -0.25409,-1.107905 9e-5,-0.25793 0.0158,-0.38759 0.0753,-0.620578 0.23562,-0.922277 0.97446,-1.64077 1.89482,-1.842851 0.22847,-0.05018 0.28703,-0.05605 0.55926,-0.05557 z" />
    """
    svg += "</g>"
    font_size = 16
    svg += f'<text x="111" y="22" font-family="monospace" font-size="{font_size}" font-weight="bold" text-anchor="middle">{tag}</text>\n'
    font_size = 10
    svg += f'<text x="10" y="84" font-family="monospace" font-size="{font_size}">{url}</text>\n'
    svg += "</svg>"
    # print(svg)
    with open(filename, "w") as f:
        f.write(svg)


def print_file(filename: str = "output.svg"):
    print(f"{filename=}")
    sp.run(["/usr/bin/inkscape", "--export-filename=output.pdf", "output.svg"])
    print('Zebra print')
    # sp.run(["lpr"] + ["-P", "Zebra-Technologies-ZTC-LP-2824-Plus",
    #                   "-o", "orientation-requested=6",  # rotate by 180deg
    #                   "output.pdf"])


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description="Ein QR-Label drucken")
    parser.add_argument("id", metavar="id", nargs=1, type=str, help="tag id an der URL")

    try:
        args = parser.parse_args()
    except SystemExit:
        sys.exit(2)
    print(args.id)

    tag = args.id[0]
    QRCode_svg(tag)

    print_file()
